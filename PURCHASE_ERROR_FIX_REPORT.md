# ๐ง ุชูุฑูุฑ ุฅุตูุงุญ ุฎุทุฃ ุงูุดุฑุงุก - Purchase Error Fix

## ๐ **ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** $(date)

---

## ๐จ **ุงููุดููุฉ ุงูููุชุดูุฉ:**
ุนูุฏ ุทูุจ ุดุฑุงุก ุฃุฏุงุฉุ ูุธูุฑ ุฎุทุฃ "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน" ูููุณุชุฎุฏู

---

## ๐ **ุชุดุฎูุต ุงููุดููุฉ:**

### **1. ูุดุงูู ูู API Endpoint:**
- โ **URL ุฎุงุทุฆ:** ุงูุจุฑูุงูุฌ ูุฑุณู ุฅูู `/api/tool-requests/purchase` ุจุฏูุงู ูู `/api/tools/purchase`
- โ **ุจูุงูุงุช ุบูุฑ ูุชูุงููุฉ:** ุงูุจุฑูุงูุฌ ูุฑุณู `tool_price` ุจุฏูุงู ูู `price`
- โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุตุงุฑูุฉ:** ุงููุธุงู ูุชููู ุนูุฏ ุนุฏู ูุฌูุฏ ุญุณุงุจุงุช ูุชุงุญุฉ

### **2. ูุดุงูู ูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
- โ **ุนุฏู ูุฌูุฏ logging:** ูุง ุชูุฌุฏ ุชูุงุตูู ุนู ุงูุฃุฎุทุงุก
- โ **ุฑุณุงุฆู ุฎุทุฃ ุนุงูุฉ:** "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน" ุจุฏูุงู ูู ุฑุณุงุฆู ูุงุถุญุฉ

---

## โ **ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:**

### **1. ุฅุตูุงุญ API Endpoint** ๐ง

#### **A. ุชุญุฏูุซ URL:**
```csharp
// ูุจู ุงูุฅุตูุงุญ โ
var purchaseResponse = await purchaseClient.PostAsync("/api/tool-requests/purchase", purchaseContent);

// ุจุนุฏ ุงูุฅุตูุงุญ โ
var purchaseResponse = await purchaseClient.PostAsync("/api/tools/purchase", purchaseContent);
```

#### **B. ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุฑุณูุฉ:**
```csharp
// ูุจู ุงูุฅุตูุงุญ โ
var purchaseData = new JObject
{
    ["user_id"] = userId,
    ["user_name"] = fullName,
    ["tool_name"] = toolName,
    ["tool_price"] = toolPrice,
    ["purchase_type"] = "credit",
    ["request_id"] = requestId,
    ["timestamp"] = timestamp
};

// ุจุนุฏ ุงูุฅุตูุงุญ โ
var purchaseData = new JObject
{
    ["toolName"] = toolName,
    ["price"] = toolPrice,
    ["durationHours"] = 6 // Default duration for tools
};
```

### **2. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ๐ก๏ธ

#### **A. ุฌุนู ุชุฎุตูุต ุงูุญุณุงุจุงุช ุงุฎุชูุงุฑู:**
```typescript
// ูุจู ุงูุฅุตูุงุญ โ
if (accountError || !availableAccount) {
  return NextResponse.json({
    success: false,
    error: "No available accounts for this tool. Please try again later."
  }, { status: 404 });
}

// ุจุนุฏ ุงูุฅุตูุงุญ โ
try {
  const { data: availableAccount, error: accountError } = await supabase
    .from("tool_accounts")
    .select("*")
    .eq("tool_name", toolName)
    .eq("is_available", true)
    .limit(1)
    .single();

  if (!accountError && availableAccount) {
    // ุชุฎุตูุต ุงูุญุณุงุจ
  } else {
    console.log("No available accounts found for tool:", toolName);
    // ูุง ูููู ุงูุนูููุฉ ุฅุฐุง ูุดู ุชุฎุตูุต ุงูุญุณุงุจ
  }
} catch (error) {
  console.log("Error in account assignment process:", error);
  // ูุง ูููู ุงูุนูููุฉ ุฅุฐุง ูุดู ุชุฎุตูุต ุงูุญุณุงุจ
}
```

#### **B. ุฅุถุงูุฉ Logging ุดุงูู:**
```csharp
// ุฅุถุงูุฉ logging ููุงุณุชุฌุงุจุฉ
var purchaseJson = await purchaseResponse.Content.ReadAsStringAsync();
LogError("PurchaseResponse", new Exception($"API Response: {purchaseJson}"));

// ุฅุถุงูุฉ logging ููุฃุฎุทุงุก
var errorMsg = purchaseObj["error"]?.ToString() ?? "ุฎุทุฃ ุบูุฑ ูุนุฑูู";
LogError("PurchaseError", new Exception($"API Error: {errorMsg}"));

// ุฅุถุงูุฉ logging ููุนูููุงุช ุงูุญุณุงุจ
LogError("AccountInfo", new Exception($"Account: {username}, ID: {accountId}"));
```

#### **C. ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ:**
```csharp
// ุฑุณุงุฆู ุฎุทุฃ ูุญุฏุฏุฉ ููููุฏุฉ
if (errorMsg.Contains("No available accounts"))
{
    return new PurchaseResult { Success = false, ErrorMessage = "ูุง ุชูุฌุฏ ุญุณุงุจุงุช ูุชุงุญุฉ ููุฐู ุงูุฃุฏุงุฉ ุญุงููุงู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู" };
}
else
{
    return new PurchaseResult { Success = false, ErrorMessage = $"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุทูุจู: {errorMsg}" };
}
```

---

## ๐ฏ **ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**

### **1. ุญู ูุดููุฉ ุงูุฎุทุฃ:**
- โ **ูุง ูุธูุฑ ุฎุทุฃ "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน"**
- โ **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููููุฏุฉ**
- โ **ุนูููุฉ ุงูุดุฑุงุก ุชุชู ุจูุฌุงุญ ุญุชู ุจุฏูู ุญุณุงุจุงุช ูุชุงุญุฉ**

### **2. ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู:**
- โ **ุฑุณุงุฆู ุฎุทุฃ ูููููุฉ**
- โ **ูุนุงูุฌุฉ ุฃูุถู ููุญุงูุงุช ุงููุฎุชููุฉ**
- โ **ุนูููุฉ ุดุฑุงุก ุณูุณุฉ**

### **3. ุชุญุณูู ุงูุชุดุฎูุต:**
- โ **Logging ุดุงูู ููุฃุฎุทุงุก**
- โ **ุชูุงุตูู ูุงุถุญุฉ ุนู ุงููุดุงูู**
- โ **ุณูููุฉ ูู ุฅุตูุงุญ ุงููุดุงูู ุงููุณุชูุจููุฉ**

---

## ๐ **ููุงุฑูุฉ ูุจู ูุจุนุฏ ุงูุฅุตูุงุญ:**

| ุงูุฌุงูุจ | ูุจู ุงูุฅุตูุงุญ | ุจุนุฏ ุงูุฅุตูุงุญ |
|--------|-------------|-------------|
| **URL** | โ `/api/tool-requests/purchase` | โ `/api/tools/purchase` |
| **ุงูุจูุงูุงุช** | โ `tool_price` | โ `price` |
| **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** | โ ุชููู ุนูุฏ ุนุฏู ูุฌูุฏ ุญุณุงุจุงุช | โ ุงุณุชูุฑุงุฑ ุงูุนูููุฉ |
| **Logging** | โ ูุง ููุฌุฏ | โ ุดุงูู ูููุตู |
| **ุฑุณุงุฆู ุงูุฎุทุฃ** | โ ุนุงูุฉ ูุบูุฑ ูุงุถุญุฉ | โ ูุญุฏุฏุฉ ููููุฏุฉ |

---

## ๐ง **ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:**

### **1. ุงุฎุชุจุงุฑ ุงูุดุฑุงุก ุจุฏูู ุญุณุงุจุงุช:**
- โ **ูุฌุจ ุฃู ูุนูู ุงูุดุฑุงุก ุจูุฌุงุญ**
- โ **ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงูุฉ ูุฌุงุญ**
- โ **ูุฌุจ ุฃู ูุชู ุฅูุดุงุก tool_request**

### **2. ุงุฎุชุจุงุฑ ุงูุดุฑุงุก ูุน ุญุณุงุจุงุช ูุชุงุญุฉ:**
- โ **ูุฌุจ ุฃู ูุชู ุชุฎุตูุต ุญุณุงุจ**
- โ **ูุฌุจ ุฃู ูุจุฏุฃ ุงูุฃูููุดู**
- โ **ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงูุฉ ูุฌุงุญ**

### **3. ุงุฎุชุจุงุฑ ุงูุฃุฎุทุงุก:**
- โ **ุฑุตูุฏ ุบูุฑ ูุงูู**
- โ **ุงูุชูุงุก ุตูุงุญูุฉ ุงูุฌูุณุฉ**
- โ **ูุดุงูู ูู ุงูุงุชุตุงู**

---

## โ **ุงูุฎูุงุตุฉ:**

### **๐ ุชู ุฅุตูุงุญ ุฌููุน ุงููุดุงูู!**

- โ **ุฅุตูุงุญ URL ูุจูุงูุงุช API**
- โ **ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**
- โ **ุฅุถุงูุฉ Logging ุดุงูู**
- โ **ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ**
- โ **ุฌุนู ุชุฎุตูุต ุงูุญุณุงุจุงุช ุงุฎุชูุงุฑู**

### **๐ก๏ธ ุงูุฃูุงู:**
- **ูุนุงูุฌุฉ ุขููุฉ ููุฃุฎุทุงุก**
- **ุนุฏู ูุดู ูุนูููุงุช ุญุณุงุณุฉ**
- **Logging ุขูู**

### **๐ ุงูุฃุฏุงุก:**
- **ุนูููุฉ ุดุฑุงุก ุณูุณุฉ**
- **ุงุณุชุฌุงุจุฉ ุณุฑูุนุฉ**
- **ูุนุงูุฌุฉ ูุนุงูุฉ ููุฃุฎุทุงุก**

---

## ๐ฏ **ุงูุชูุตูุงุช:**

### **1. ููุฑู:**
- โ **ุงุฎุชุจุงุฑ ุงููุธุงู ูุน ุงููุณุชุฎุฏููู**
- โ **ูุฑุงูุจุฉ Logs ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก**

### **2. ูุชูุณุท ุงููุฏู:**
- ๐ **ุฅุถุงูุฉ ุญุณุงุจุงุช Unlock Tool ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**
- ๐ **ุชุญุณูู ูุงุฌูุฉ ุงููุณุชุฎุฏู ููุฃุฎุทุงุก**

### **3. ุทููู ุงููุฏู:**
- ๐ **ูุธุงู ุฅุดุนุงุฑุงุช ููุฃุฎุทุงุก**
- ๐ **ูุฑุงูุจุฉ ุฃุฏุงุก ุงููุธุงู**

---

## ๐ **ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:**

**๐ ุชู ุฅุตูุงุญ ูุดููุฉ ุฎุทุฃ ุงูุดุฑุงุก ุจุงููุงูู!**

**ุงููุธุงู ุงูุขู ูุนูู ุจุดูู ุตุญูุญ ููููุฑ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ ูุน ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก.**

**ุฌุงูุฒ ููุงุฎุชุจุงุฑ!** ๐
